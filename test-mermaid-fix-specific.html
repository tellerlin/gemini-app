<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾äººé±¼æµç¨‹å›¾ä¿®å¤æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.9.0/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: "Noto Sans CJK SC", "Microsoft YaHei", "SimHei", sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }
        
        pre {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .error {
            background-color: #fff5f5;
            border: 1px solid #fed7d7;
            color: #c53030;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .success {
            background-color: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #38a169;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ§œâ€â™€ï¸ ç¾äººé±¼æµç¨‹å›¾ä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>åŸå§‹é—®é¢˜ä»£ç  (åº”è¯¥å¤±è´¥):</h2>
        <pre>graph TD
    A[ç¾äººé±¼å‡ºç”Ÿ] --> B{æ¢ç´¢æµ·æ´‹}
    B --> C{å­¦ä¹ é­”æ³•}
    C --> D{å¯»æ‰¾çœŸçˆ±}
    D --> E[æˆä¸ºæµ·æ´‹å¥³ç‹]</pre>
        
        <div id="result1" class="error">æµ‹è¯•ä¸­...</div>
        <div class="mermaid" id="mermaid1">
graph TD
    A[ç¾äººé±¼å‡ºç”Ÿ] --> B{æ¢ç´¢æµ·æ´‹}
    B --> C{å­¦ä¹ é­”æ³•}
    C --> D{å¯»æ‰¾çœŸçˆ±}
    D --> E[æˆä¸ºæµ·æ´‹å¥³ç‹]
        </div>
    </div>

    <div class="test-section">
        <h2>ä¿®å¤åçš„ä»£ç  (åº”è¯¥æˆåŠŸ):</h2>
        <pre>graph TD
    A["ç¾äººé±¼å‡ºç”Ÿ"] --> B{"æ¢ç´¢æµ·æ´‹"}
    B --> C{"å­¦ä¹ é­”æ³•"}
    C --> D{"å¯»æ‰¾çœŸçˆ±"}
    D --> E["æˆä¸ºæµ·æ´‹å¥³ç‹"]</pre>
        
        <div id="result2" class="success">æµ‹è¯•ä¸­...</div>
        <div class="mermaid" id="mermaid2">
graph TD
    A["ç¾äººé±¼å‡ºç”Ÿ"] --> B{"æ¢ç´¢æµ·æ´‹"}
    B --> C{"å­¦ä¹ é­”æ³•"}
    C --> D{"å¯»æ‰¾çœŸçˆ±"}
    D --> E["æˆä¸ºæµ·æ´‹å¥³ç‹"]
        </div>
    </div>

    <div class="test-section">
        <h2>æ¨¡æ‹Ÿä¿®å¤å‡½æ•°æµ‹è¯•:</h2>
        <div id="function-test"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿä¿®å¤å‡½æ•°
        function fixMermaidSyntax(mermaidCode) {
            let fixed = mermaidCode.trim();
            
            if (!fixed) return fixed;
            
            console.log('ä¿®å¤å‰:', fixed);
            
            // ä¿®å¤ä¸­æ–‡æ ‡ç‚¹
            fixed = fixed.replace(/ï¼Ÿ/g, '?');
            fixed = fixed.replace(/ï¼š/g, ':');
            fixed = fixed.replace(/ï¼›/g, ';');
            fixed = fixed.replace(/ï¼ˆ/g, '(');
            fixed = fixed.replace(/ï¼‰/g, ')');
            fixed = fixed.replace(/ã€/g, '[');
            fixed = fixed.replace(/ã€‘/g, ']');
            fixed = fixed.replace(/ï½›/g, '{');
            fixed = fixed.replace(/ï½/g, '}');
            fixed = fixed.replace(/ï¼Œ/g, ',');
            fixed = fixed.replace(/ã€‚/g, '.');
            
            // ä¸ºåŒ…å«ä¸­æ–‡çš„èŠ‚ç‚¹æ ‡ç­¾æ·»åŠ å¼•å·
            fixed = fixed.replace(/(\w+)\[([\u4e00-\u9fff\/\:\?\!\,\.\s\-\+\*\&\%\$\#\@\(\)]+)\]/g, '$1["$2"]');
            fixed = fixed.replace(/(\w+)\{([\u4e00-\u9fff\/\:\?\!\,\.\s\-\+\*\&\%\$\#\@\(\)]+)\}/g, '$1{"$2"}');
            fixed = fixed.replace(/(\w+)\(([\u4e00-\u9fff\/\:\?\!\,\.\s\-\+\*\&\%\$\#\@\(\)]+)\)/g, '$1("$2")');
            
            // ä¿®å¤é”™è¯¯çš„ç®¡é“ç¬¦å·
            fixed = fixed.replace(/([A-Za-z0-9]+)\|\s+([A-Za-z0-9]+)/g, '$1 --> $2');
            fixed = fixed.replace(/([A-Za-z0-9]+)\s+\|([A-Za-z0-9]+)/g, '$1 --> $2');
            fixed = fixed.replace(/\s+\|\s+/g, ' --> ');
            
            // æ¸…ç†ç©ºç™½å’Œæ¢è¡Œ
            fixed = fixed.replace(/[ \t]+/g, ' ');
            fixed = fixed.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .join('\n');
            
            console.log('ä¿®å¤å:', fixed);
            
            return fixed;
        }

        // é…ç½® Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: '"Noto Sans CJK SC", "Microsoft YaHei", "SimHei", sans-serif',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 15
            }
        });

        // æµ‹è¯•å‡½æ•°
        async function testMermaidDiagram(id, resultId) {
            const element = document.getElementById(id);
            const resultElement = document.getElementById(resultId);
            
            try {
                await mermaid.run({
                    nodes: [element]
                });
                resultElement.textContent = 'âœ… æ¸²æŸ“æˆåŠŸ';
                resultElement.className = 'success';
            } catch (error) {
                console.error(`${id} æ¸²æŸ“å¤±è´¥:`, error);
                resultElement.textContent = `âŒ æ¸²æŸ“å¤±è´¥: ${error.message}`;
                resultElement.className = 'error';
            }
        }

        // æµ‹è¯•ä¿®å¤å‡½æ•°
        function testFixFunction() {
            const originalCode = `graph TD
    A[ç¾äººé±¼å‡ºç”Ÿ] --> B{æ¢ç´¢æµ·æ´‹}
    B --> C{å­¦ä¹ é­”æ³•}
    C --> D{å¯»æ‰¾çœŸçˆ±}
    D --> E[æˆä¸ºæµ·æ´‹å¥³ç‹]`;

            const fixedCode = fixMermaidSyntax(originalCode);
            
            document.getElementById('function-test').innerHTML = `
                <h3>åŸå§‹ä»£ç :</h3>
                <pre>${originalCode}</pre>
                <h3>ä¿®å¤åçš„ä»£ç :</h3>
                <pre>${fixedCode}</pre>
                <h3>ä¿®å¤äº†å“ªäº›é—®é¢˜:</h3>
                <ul>
                    <li>ä¸ºåŒ…å«ä¸­æ–‡å­—ç¬¦çš„èŠ‚ç‚¹æ ‡ç­¾æ·»åŠ äº†å¼•å·</li>
                    <li>æ¸…ç†äº†æ ¼å¼å’Œç©ºç™½å­—ç¬¦</li>
                    <li>ç¡®ä¿è¯­æ³•ç¬¦åˆMermaidè§„èŒƒ</li>
                </ul>
            `;
        }

        // è¿è¡Œæµ‹è¯•
        async function runAllTests() {
            testFixFunction();
            
            await testMermaidDiagram('mermaid1', 'result1');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testMermaidDiagram('mermaid2', 'result2');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>