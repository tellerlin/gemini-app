<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美人鱼流程图修复测试</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.9.0/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: "Noto Sans CJK SC", "Microsoft YaHei", "SimHei", sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }
        
        pre {
            background: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        
        .error {
            background-color: #fff5f5;
            border: 1px solid #fed7d7;
            color: #c53030;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .success {
            background-color: #f0fff4;
            border: 1px solid #9ae6b4;
            color: #38a169;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🧜‍♀️ 美人鱼流程图修复测试</h1>
    
    <div class="test-section">
        <h2>原始问题代码 (应该失败):</h2>
        <pre>graph TD
    A[美人鱼出生] --> B{探索海洋}
    B --> C{学习魔法}
    C --> D{寻找真爱}
    D --> E[成为海洋女王]</pre>
        
        <div id="result1" class="error">测试中...</div>
        <div class="mermaid" id="mermaid1">
graph TD
    A[美人鱼出生] --> B{探索海洋}
    B --> C{学习魔法}
    C --> D{寻找真爱}
    D --> E[成为海洋女王]
        </div>
    </div>

    <div class="test-section">
        <h2>修复后的代码 (应该成功):</h2>
        <pre>graph TD
    A["美人鱼出生"] --> B{"探索海洋"}
    B --> C{"学习魔法"}
    C --> D{"寻找真爱"}
    D --> E["成为海洋女王"]</pre>
        
        <div id="result2" class="success">测试中...</div>
        <div class="mermaid" id="mermaid2">
graph TD
    A["美人鱼出生"] --> B{"探索海洋"}
    B --> C{"学习魔法"}
    C --> D{"寻找真爱"}
    D --> E["成为海洋女王"]
        </div>
    </div>

    <div class="test-section">
        <h2>模拟修复函数测试:</h2>
        <div id="function-test"></div>
    </div>

    <script>
        // 模拟修复函数
        function fixMermaidSyntax(mermaidCode) {
            let fixed = mermaidCode.trim();
            
            if (!fixed) return fixed;
            
            console.log('修复前:', fixed);
            
            // 修复中文标点
            fixed = fixed.replace(/？/g, '?');
            fixed = fixed.replace(/：/g, ':');
            fixed = fixed.replace(/；/g, ';');
            fixed = fixed.replace(/（/g, '(');
            fixed = fixed.replace(/）/g, ')');
            fixed = fixed.replace(/【/g, '[');
            fixed = fixed.replace(/】/g, ']');
            fixed = fixed.replace(/｛/g, '{');
            fixed = fixed.replace(/｝/g, '}');
            fixed = fixed.replace(/，/g, ',');
            fixed = fixed.replace(/。/g, '.');
            
            // 为包含中文的节点标签添加引号
            fixed = fixed.replace(/(\w+)\[([\u4e00-\u9fff\/\:\?\!\,\.\s\-\+\*\&\%\$\#\@\(\)]+)\]/g, '$1["$2"]');
            fixed = fixed.replace(/(\w+)\{([\u4e00-\u9fff\/\:\?\!\,\.\s\-\+\*\&\%\$\#\@\(\)]+)\}/g, '$1{"$2"}');
            fixed = fixed.replace(/(\w+)\(([\u4e00-\u9fff\/\:\?\!\,\.\s\-\+\*\&\%\$\#\@\(\)]+)\)/g, '$1("$2")');
            
            // 修复错误的管道符号
            fixed = fixed.replace(/([A-Za-z0-9]+)\|\s+([A-Za-z0-9]+)/g, '$1 --> $2');
            fixed = fixed.replace(/([A-Za-z0-9]+)\s+\|([A-Za-z0-9]+)/g, '$1 --> $2');
            fixed = fixed.replace(/\s+\|\s+/g, ' --> ');
            
            // 清理空白和换行
            fixed = fixed.replace(/[ \t]+/g, ' ');
            fixed = fixed.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .join('\n');
            
            console.log('修复后:', fixed);
            
            return fixed;
        }

        // 配置 Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: '"Noto Sans CJK SC", "Microsoft YaHei", "SimHei", sans-serif',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                padding: 15
            }
        });

        // 测试函数
        async function testMermaidDiagram(id, resultId) {
            const element = document.getElementById(id);
            const resultElement = document.getElementById(resultId);
            
            try {
                await mermaid.run({
                    nodes: [element]
                });
                resultElement.textContent = '✅ 渲染成功';
                resultElement.className = 'success';
            } catch (error) {
                console.error(`${id} 渲染失败:`, error);
                resultElement.textContent = `❌ 渲染失败: ${error.message}`;
                resultElement.className = 'error';
            }
        }

        // 测试修复函数
        function testFixFunction() {
            const originalCode = `graph TD
    A[美人鱼出生] --> B{探索海洋}
    B --> C{学习魔法}
    C --> D{寻找真爱}
    D --> E[成为海洋女王]`;

            const fixedCode = fixMermaidSyntax(originalCode);
            
            document.getElementById('function-test').innerHTML = `
                <h3>原始代码:</h3>
                <pre>${originalCode}</pre>
                <h3>修复后的代码:</h3>
                <pre>${fixedCode}</pre>
                <h3>修复了哪些问题:</h3>
                <ul>
                    <li>为包含中文字符的节点标签添加了引号</li>
                    <li>清理了格式和空白字符</li>
                    <li>确保语法符合Mermaid规范</li>
                </ul>
            `;
        }

        // 运行测试
        async function runAllTests() {
            testFixFunction();
            
            await testMermaidDiagram('mermaid1', 'result1');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testMermaidDiagram('mermaid2', 'result2');
        }

        // 页面加载完成后运行测试
        document.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>